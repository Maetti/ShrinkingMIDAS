---
title: "Untitled"
author: "Matthias Hauser"
date: "29 10 2020"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    highlight: tango
    fig_width: 16
    fig_height: 12
params:
  dirDGP: "/home/matthias/Schreibtisch/SoSe 2020/Empirical Finance and Financial Econometrics/assignment II/midasExperimentR/inst/data/01_dgp/"
---

```{r setup, include=FALSE}
# output: rmdformats::html_docco
# output:
#   prettydoc::html_pretty:
#     theme: leonids
#     highlight: github
    
    
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, error = FALSE, warning = FALSE, 
                      fig.height = 12, fig.width = 16)
# rmarkdown::find_pandoc(version = "2.11.0.4")
library(dplyr)
library(ggplot2)
library(loo)

library(midasExperimentR)

# params <- list(dirDGP = "/home/matthias/Schreibtisch/SoSe 2020/Empirical Finance and Financial Econometrics/assignment II/midasExperimentR/inst/data/01_dgp/")

```

```{r datafactory, cache=FALSE}
dirExtract <- paste0(params$dirDGP, "/", dir(params$dirDGP), "/output/stan_extract/")
l1 <- lapply(dirExtract, function(x) arrow::dataset_factory(x, partitioning = c("simulation", "model")))
arrData <- arrow::open_dataset(l1)


sIteration <- seq(0, 16000, 8)
sIteration[1] <- 1


fSims <- dir(params$dirDGP)
lYTrue_raw <- vector("list", length(params$dirDGP))
for (i in seq_along(fSims)) {
      sFile <- dir(paste0(params$dirDGP, "/", fSims[[i]], "/raw_input"))
      s1 <- readRDS(paste0(params$dirDGP, "/", fSims[[i]], "/raw_input/", sFile))
      lYTrue_raw[[i]] <- data.frame(simulation = i,
                                 key = seq(1, s1$nY_train +  s1$nY_test),
                                 value = c(s1$y_train, s1$y_test))
}
tblYTrue <- dplyr::bind_rows(lYTrue_raw) %>% dplyr::as_tibble()

tblYTrain <- tblYTrue %>% dplyr::filter(key <= 150)
tblYTest <- tblYTrue %>% dplyr::filter(key > 150)
tblYTest$key <- tblYTest$key - 150

nSim <- length(fSims)
```


# MCMC Diagnosis

```{r}

```


# Model Diagnosis

```{r yrep loading, cache=TRUE}
tblYRep <-
      arrData %>%
            dplyr::filter(parameter_1 == "y_rep",
                          # simulation == 1,
                          iteration %in% sIteration) %>%
            dplyr::collect() %>%
            dplyr::mutate(parameter = paste0(parameter_1, "_", parameter_2)) %>%
            dplyr::select(-parameter_1, parameter_2)
```


## Statistics of Y Replication

### Basic Statistics {.tabset}

#### Overall

```{r yrep pvalue calc, cache=TRUE}
tblYrep_pval <- md_check_yrep_pval(tblYRep, tblYTrain)
```

```{r}
md_check_yrep_pval_plot(tblYrep_pval)
```

#### Mean {.tabset}

```{r yrep sim mean, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYRep, tblYTrain, sSim = i, sStat = "mean", .fInput = "stat_group"))
   cat('\n') 
}
```

#### Max {.tabset}

```{r yrep sim max, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYRep, tblYTrain, sSim = i, sStat = "max", .fInput = "stat_group"))
   cat('\n') 
}
```

#### Min {.tabset}

```{r yrep sim min, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYRep, tblYTrain, sSim = i, sStat = "min", .fInput = "stat_group"))
   cat('\n') 
}
```

#### Scatter {.tabset}

```{r yrep sim scatter, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYRep, tblYTrain, sSim = i, .fInput = "scatter"))
   cat('\n') 
}
```


#### Intervalls {.tabset}

```{r yrep sim intervalls, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYRep, tblYTrain, sSim = i, .fInput = "intervals"))
   cat('\n') 
}
```

### Covered Y rep

```{r yrep covere}
tblYrep_covered <- md_check_yrep_95_covered(tblYRep, tblYTrain)
```

```{r}
md_check_yrep_95_covered_plot(tblYrep_covered)
```

```{r}
rm(tblYRep)
gc()
```




# Posterior Analysis

```{r beta data loading}
tblBeta <-
      arrData %>%
            dplyr::filter(parameter_1 == "beta", iteration %in% sIteration) %>%
            dplyr::collect() %>%
            dplyr::mutate(parameter = paste0(parameter_1, "_", parameter_2)) %>%
            dplyr::select(-parameter_1, -parameter_2)

vBeta <- c(0, 0.4, 1.2, 0, 0, 0.8, 1, 0, 0, 0)
bolTrue <- vBeta != 0
vTrueValue <- vBeta[bolTrue]

tblBetaTrue <- data.frame(
      parameter = paste0("beta_", seq_along(vBeta)),
      beta_true = vBeta,
      bolTrue = bolTrue
)
bolTrue <- vBeta != 0
vTrueValue <- vBeta[bolTrue]

tblConf <-
      tblBeta %>%
            dplyr::group_by(model, simulation) %>%
            tidyr::nest() %>%
            dplyr::mutate(data = purrr::map(data, function(x, bolTrue) {
                  x %>%
                        tidyr::pivot_wider(names_from = "parameter", values_from = "value") %>%
                        dplyr::select(-iteration) %>%
                        as.matrix() %>%
                        md_check_beta_create_confusion_matrix_foo(., bolTrue)
            }, bolTrue)) %>%
            tidyr::unnest(cols = c(data)) %>%
            dplyr::ungroup()
```


```{r beta mse tpr fpr}
tblBeta_mse <- md_check_beta_mse(tblBeta, tblBetaTrue)

tbMatCorr <- md_check_beta_matthes_cor(tblConf)
tbMatCorr <- 
   tbMatCorr %>% 
      dplyr::select(model, tpr, fpr, mcc) %>% 
      dplyr::mutate(tpr = tpr * 100, fpr = fpr * 100)


sketchBeta = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Models'),
      th(colspan = 3, 'MSE'),
      th(colspan = 3, 'TPR/FPR')
    ),
    tr(
      lapply(c("MSE", "VAR", "BIAS", "TPR", "FPR", "MCC"), th)
    )
  )
))


dplyr::left_join(tblBeta_mse, tbMatCorr, by = "model") %>% 
   dplyr::mutate_if(is.numeric, ~round(., 4)) %>% 
   DT::datatable(., container = sketchBeta, rownames = FALSE)
```

## TP/FN {.tabset}

### Overall

```{r all beta tp, results='asis'}
tbl1 <- md_check_beta_tpfp_table(tblBeta, tblBetaTrue)
DT::datatable(tbl1, rownames = FALSE,
              extensions = 'FixedColumns',
              options = list(
                dom = 't',
                scrollX = TRUE,
                fixedColumns = list(leftColumns = 1)
              ))
```


### True Positive
```{r}
md_check_beta_tp_fp_plot(tblConf, "TP")
```

### False Negative
```{r}
md_check_beta_tp_fp_plot(tblConf, "FN")
```


## Beta Distribution 

### Non Zero Coefficent {.tabset}

```{r non zero coefficient, results='asis'}
l1 <- md_check_beta_distribution(tblBeta, tblBetaTrue, bolTrueOnly = TRUE, sWrap = "simulation")
sBeta <- tblBetaTrue %>% dplyr::filter(bolTrue == TRUE)

for (i in seq_along(l1)) {
   cat('\n')  
   cat("#### Beta ", as.character(sBeta$parameter)[[i]], "\n") 
   print(l1[[i]])
   cat('\n') 
}
```

### All Coefficient {.tabset}

```{r all coefficient, results='asis'}
l2 <- md_check_beta_distribution(tblBeta, tblBetaTrue, bolTrueOnly = FALSE, sWrap = "model")

for (i in seq_along(l2)) {
   cat('\n')  
   cat("#### Beta ", as.character(tblBetaTrue$parameter)[[i]], "\n") 
   print(l2[[i]])
   cat('\n') 
}
```




# Prediction

```{r ypred loading}
tblYPred <-
      arrData %>%
            dplyr::filter(parameter_1 == "y_pred",
                          # simulation == 1,
                          iteration %in% sIteration) %>%
            dplyr::collect() %>%
            dplyr::mutate(parameter = paste0(parameter_1, "_", parameter_2)) %>%
            dplyr::select(-parameter_1, parameter_2)

tblYPred_mse <- md_ypred_mse(tblYPred, tblYTest)
```

```{r ypred loglik}
tblLogLik <-
   arrData %>%
      dplyr::filter(parameter_1 == "log_lik",
                    iteration %in% sIteration) %>%
      dplyr::collect() %>%
      dplyr::mutate(parameter = paste0(parameter_1, "_", parameter_2)) %>%
      dplyr::select(-parameter_1, parameter_2)

tblLoo <- md_ypred_loo_clean(tblLogLik)

tblELPD <- tblLoo %>% dplyr::filter(key == "elpd_loo")
```

## Overview {.tabset}

### Table

```{r ypred elpd rmse dt, results='asis'}
tblYPred_mse_stat <- md_ypred_stat_foo(tblYPred_mse)
tblLogLike_stat <- md_ypred_stat_foo(tblELPD)

colnames(tblYPred_mse_stat)[-1] <- paste0("rmse_", colnames(tblYPred_mse_stat)[-1])
colnames(tblLogLike_stat)[-1] <- paste0("elpd_", colnames(tblLogLike_stat)[-1])

sketchYPRED = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Models'),
      th(colspan = 3, 'ELPD'),
      th(colspan = 3, 'RMSE')
    ),
    tr(
      lapply(rep(c('Mean', 'Min', 'Max'), 2), th)
    )
  )
))


dplyr::left_join(tblLogLike_stat, tblYPred_mse_stat, by = "model") %>% 
   dplyr::mutate_if(is.numeric, ~round(., 4)) %>% 
   DT::datatable(., container = sketchYPRED, rownames = FALSE)
```

### Expected Log Pointwise Predictive Density (ELPD)

The higher the better

```{r}
md_check_general_sim_plot(tblELPD, sTitle = "Expected Log Pointwise Predictive Density", sYtitle = "ELPD", sXtitle = "Simulation")
```

### RSME

```{r}
md_check_general_sim_plot(tblYPred_mse, sTitle = "Prediction RMSE", sYtitle = "RMSE", sXtitle = "Simulation")
```


## Prediction Plots {.tabset}

### Overall

```{r ypred covere}
tblYrep_covered <- md_check_yrep_95_covered(tblYPred, tblYTest)
```

```{r}
tb1 <- tblYrep_covered %>% dplyr::rename(value = covered)
md_check_general_sim_plot(tb1, 
                          sTitle = "Percentage of true Y observation in 95% prediction Intervall", 
                          sYtitle = "% within 95% prediction intervall", sXtitle = "Simulation")
```

### Per Simulation {.tabset}

#### 90% Predictive Intervals {.tabset}

```{r ypred 90 prdiciton intervals, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_ypred_pred_interval_plot(tblYPred, tblYTest, nSim = i))
   cat('\n') 
}
```

#### Intervalls {.tabset}

```{r ypred intervalls, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYPred, tblYTest, sSim = i, .fInput = "intervals", sTitle = "Test Data"))
   cat('\n') 
}
```

#### Scatter {.tabset}
```{r ypred sim scatter, results='asis'}
for (i in 1:3) {
   cat('\n')  
   cat("##### Simulation ", i, "\n") 
   print(md_yrep_stat_simulation_plot(tblYPred, tblYTest, sSim = i, .fInput = "scatter", sTitle = "Test Data"))
   cat('\n') 
}
```


```{r}
rm(tblYPred)
rm(tblYTest)
```

